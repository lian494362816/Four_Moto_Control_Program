#include "msp430F5438A.h"
#include "clock.h"
#include "delay.h"
#include "uart0.h"
#include "stdio.h"
#include "include.h"
extern char Flag_PID_Change ;
void INIT(void);
/*   IIC  */
//SDA P10.1
//SCL P10.2

/*  PWM输入*/
//  P1.2/TA0.1|--> YAW
//  P1.3/TA0.2|-->THROTTLE
//  P1.4/TA0.3|-->PITCH
//  P1.5/TA0.4|-->ROLL


/*  PWM 输出 */
//  P4.2/TB2|--> CCR2     
//  P4.3/TB3|--> CCR3 
//  P4.4/TB4|--> CCR4 
//  P4.5/TB5|--> CCR5
  
/* UART0 */
//    用来与串口软件相连
//    Tx P3.4
//    Rx P3.5

/* UART1 */
//    用来与恒拓地面站（上位机）相连
//    Tx P5.6
//    Rx P5.7

/*
    1,数据保存问题 MPU6050 HMC5883L
    2,第一个LED亮代表正在陀螺仪校准
     第一个LED灭亮代表校准陀螺仪校准成功
    3,磁力计一显示有问题，不用去管

    4,行器解锁，把油门调到最低， 右手边的遥杆也打到最低
     然后看见4个LED灯亮0.5秒

    5,串口1用来与上位相机器连
     串口0用来与串口软件相连

    6,LED4代表飞机上锁
    
    
    7,磁力计校准，使飞机处于上锁，油门打到最低，右摇杆打到最高
      此时4个LED闪2次
      LED1亮时，飞控板平放并旋转至LED1灭
      LED2亮时，飞控板X轴向下并旋转至LED2灭
      LED3亮时，飞控板Y轴向下并旋转至LED3灭
*/

void main( void )
{
    
    // Stop watchdog timer to prevent time out reset
    WDTCTL = WDTPW + WDTHOLD;
    _EINT();

    INIT();
//    TA0CCTL0 &= ~CCIE;
//    TA0CCTL1 &= ~CCIE;
//    TA0CCTL2 &= ~CCIE;
//    TA0CCTL3 &= ~CCIE;
//    TA0CCTL4 &= ~CCIE;
    while(1) 
    {   
            
        //AHRS_getValues();
//        if(Flag_PID_Change)
//        {
////            PID_to_flash();
////            float_write_flash();
////            flash_to_PID();
//            //Delay_ms(5);      
//             
//            HtoEs_PID_Data_Generate();//显示各PID的参数 ,显示2次保证能够正常刷新
//            HtoEs_PID_Data_Generate();
//            HtoEs_PID_Data_Generate();
//            HtoEs_PID_Data_Generate();
//            Printf_PID();//串口显示PID的参数 
//            Flag_PID_Change = 0;
//        }
//        TA0CCR1 = 2000;
//        TA0CCR2 = 2000;
//        TA0CCR3 = 2000;
//        TA0CCR4 = 2000;
//        Delay_ms(5000);
//        TA0CCR1 = 1200;
//        TA0CCR2 = 1200;
//        TA0CCR3 = 1200;
//        TA0CCR4 = 1200;
//        Delay_ms(5000);
    }

}

void INIT(void)
{
    Clock_Init();
    //LED_Init();
    Uart0_Init();
    Uart1_Init();
    I2C_Init();
    printf("\r\n printf test!\r\n");//测试printf函数
    MPU6050_Init();
    MPU6050_WHO_AM_I();//检测MPU6050 是否连接成功 
    MPU6050_Dataanl();
    Init_HMC5883L();
    Identify_HMC5883L();
    paramLoad();
    HtoEs_PID_Data_Generate();  
    flag.calibratingA = 1; //加速度计补偿
    TimerA_PWM_In_Init();
    TimerB_PWM_Out_Init();
    Printf_PID();
    flag.ARMED = 0;//飞机上锁                                                                                        
//    LED4_ON; //表示飞机已上锁
    //DMA0_Uart1_Tx_Init();
    //flag.ARMED = 1; //启动电机
    
    /* 读取之前保存的PID*/
    flash_to_PID();
    Printf_PID();
//    HtoEs_PID_Data_Generate();
//    HtoEs_PID_Data_Generate();
    
}